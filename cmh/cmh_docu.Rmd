---
title: "CMH_Test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cochran-Mantel-Haenszel Test - Overview

The CMH procedure tests for conditional independence in partial tables usually for a 2x2xK design. However, it can be generalized to IxJxK tables (Agresti). Depending on the nature of the variables, the number of degrees of freedom differs: 

- general association statstic (X and Y are treated as nominal) results in (X-1) * (Y-1) dfs
- row mean scores statistic (X is nominal and Y is ordinal) results in X-1 dfs
- nonzero correlation statistic (X and Y ordinal) results in 1 df

To be consistent between SAS and R, the following naming conventions are used when referring to variables below: 

X = exposure 

Y = response 

K = control 



## Implementation

### Data 

For the further documentation the CDSIC data were used and pre-preocessed: 

```{r, eval = FALSE}
### how to get data 
### pre-filtering data 

haven::read_xpt("https://github.com/phuse-org/TestDataFactory/raw/main/Updated/TDF_ADaM/adcibc.xpt") %>% 
  filter(EFFFL == 'Y' & ITTFL == 'Y', AVISITN == 8 & ANL01FL=='Y') 

```


### In SAS 


https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.3/statug/statug_freq_examples07.htm


```{r, eval = FALSE}

Proc freq data = filtered_data; 
tables K * X * Y / cmh; 
run; 

```


### In R 

The Freq Approach in SAS automatically delivers all three statistics, however this is only true for the vcdExtra package in R.

- base R
- vcdExtra package


#### CMH statistics

The vcdExtra package provides results for the generalized CMH test, for each of the three model it outputs the Chi-square value and the respective p-values. 

```{r, eval = FALSE}
library(vcdExtra)
CMHtest(Freq~X+Y|K,data=filtered_data, overall=TRUE) 
```


#### Common odds ratio

To get the common odds ration another package has to be used in R...

```{r, eval = FALSE}
library(epiDisplay) 

s1data_or <- adcibc %>%  

  filter(AGEGR1 != "<65" & TRTP != "Xanomeline High Dose") %>% 

  dplyr::select(AGEGR1, TRTP, SEX) 
```


#### Homogenity Test

```{r, eval = FALSE}
mhor(s1data_or$TRTP, s1data_or$SEX,  s1data_or$AGEGR1) 
```


### Testing Schema

To compare the SAS and R output across multiple data combinations we used these schemata:

[schema table]


### Results

Here the results can be seen: 

[results table]

We can see for cases where ... R and SAS deliver almost the same output. However, if xxx there appear differences. 

### References

https://online.stat.psu.edu/stat504/lesson/5/5.4/5.4.5
